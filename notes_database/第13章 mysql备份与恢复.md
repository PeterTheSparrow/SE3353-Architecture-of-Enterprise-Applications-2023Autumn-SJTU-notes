# 第13讲 MySQL的备份与恢复

2023.10.03

>Memories beyond the line
선 너머에 기억이
calling me
나를 부르고 있어
for a very long time
아주 오랜 시간 동안
In a voice I had forgotten
잊고 있던 목소리에
I go back against the wave
물결을 거슬러 나 돌아가
To the place where the sea inside me was born
내 안의 바다가 태어난 곳으로
Even if you are swept away and lost, you are free
휩쓸려 길을 잃어도 자유로와
I no longer close my eyes to the darkness that traps me
더이상 날 가두는 어둠에 눈 감지 않아
Never pretend not to know me again
두 번 다시 날 모른 척 하지 않아
Still sometimes
그럼에도 여전히 가끔은
There will be days when you lose to life
삶에게 지는 날들도 있겠지
Even if I get lost again, I know the way back
또다시 헤매일지라도 돌아오는 길을 알아
> ——《My Sea》 IU


## 0. Intro

提高数据库容灾能力。既然是备份容灾，那我读的时候也能去备份的节点上面读呀（master上read/write, slave上只read）！所以访问的性能也能有所提高。

## 1. 备份的类型

- **逻辑备份**（记住用户做了哪些操作，sql语句全部记录下来）、**物理备份**（把数据文件全部拷贝）

- **全量备份**、**增量备份**（所有数据全部备份还是记录从上一个时刻到现在增量）
恢复的方法、备份数据的加密？

## 2. 物理、逻辑备份

### 2.1 物理备份

**物理备份**：拷贝整个表格，索引文件、数据文件、元数据文件，当出现故障的时候，把所有的文件拷贝回去就好了。

优点：
- 适合大的数据库。
- 恢复速度快，出现问题的时候直接把文件拷贝回去就好了，方便快捷恢复便利。
- 相对来说安全一些。

缺点：
- 比如从Mysql备份的内容就只能用于Mysql，不能像逻辑备份一样导入到别的类型的数据库。

### 2.2 逻辑备份

**逻辑备份**：先要备份表的结构，然后记录所有的SQL语句的操作，比如所有的增删改查的操作。当一个表崩溃的时候，在另外一个表里面按照顺序执行一遍这些操作，就可以实现备份的恢复。


优点：
- 因为备份的是SQL语句，所以换一个机器也能执行，换一个数据库系统也能执行。比如从MySQL导出的SQL脚本备份，换到oracle也一般可以执行，兼容性好。（你标准SQL，都可以执行的）反之你物理备份就不行了，比如MySQL->oracle, linux->windows，只做物理备份，导出来的文件肯定是不能用的。
  
缺点：
- 空间占用比较大，SQL的脚本文件因为还包含了SQL的关键字，所以比只存储数据的表格文件是要大的，牺牲了一部分的空间，在数据量比较大的时候，导出的SQL备份脚本文件会比较浪费空间。
- SQL文件如果泄露了的话，数据库就泄露了，安全性差。



## 3. 在线备份和离线备份

- **在线备份**：不停机地做（热备份）；在系统在运行的时候备份。缺点管理很复杂，涉及到各种加锁，优点是用户还可以使用；
- **离线备份**：数据库暂停服务，然后专门备份（冷备份）。缺点是用户不能使用了。
- 组合：暖备份。数据库还在跑，但是锁住不让你修改数据。

## 4. 快照

**增量式备份**的一种，一些文件系统实现允许拍摄“快照”。它们在给定时间点提供文件系统的逻辑拷贝，而不需要整个文件系统的物理拷贝。（例如，实现可以使用copy-on-write技术，以便只复制快照时间后修改的文件系统的部分。）

MySQL本身不提供获取文件系统快照的功能。它可以通过Veritas、LVM或ZFS等第三方解决方案获得。

实际上，由于copy-on-write技术，假如在某个时间我们做了一个全量备份，那么之后由于数据库的增删改，然后出现了文件数据的变化，文件相对于旧有的文件会有一部分变化，**这部分变化就叫做快照**！所以快照是增量式备份。

**增量备份记录在bin-log里面**。

## 5. 恢复方法

### 5.1 补充：背景知识

我们来细致地看一下MySQL的结构。

其实是分两层的，一层是上面的Server，这是面向用户的，用户发过来的SQL请求，你来做处理；第二层是引擎，InnoDB or MyISAM，默认现在用的是InnoDB。引擎在这里负责的是和文件系统交互。有一个很大的buffer缓存。有很多log：undo log，redo log，整个这一层操作的时候它看不到SQL，只看到文件。

上面的SQL是在处理SQL的，它对应的log就是**bin-log**，**它记住你执行的所有的SQL操作**。

这两层之间是可以解耦的。解耦的好处就是，我在linux或者windows上面安装MySQL，我只需要改engine这一层就可以了。

### 5.2 恢复方法

假设我们的备份策略是每个周日下午一点进行一次全量备份，也就是把数据库里面的所有数据全备份一次。那么，**在两次全量备份之间，数据库每次执行写入操作的时候，都会对bin-log文件进行操作，写入增量备份**。也就是记录用户对数据库的所有的操作变更。现在假如在周三的中午，数据库主机突然崩了，那么我们首先要恢复到最近一次做的全量备份：好了，现在就已经恢复到最近一次全量备份的状态里，然后要从上次全量备份到崩溃期间的binlog文件全部读取出来，然后恢复。如果每次磁盘坏死或者磁盘错误，基本上就能恢复到原来的状态。但是如果有一个binlog文件崩溃了或者寄了，那就可能恢复不到周三崩溃的时候的状态了，可能只能恢复到周二的下午或者某个稍微更早的时间点。